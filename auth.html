<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"/>
  <title>Acceso — Segundo Login</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Estilos -->
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0a0a0a;
      --muted: #444;
      --card: #f9fafb;
      --stroke: #e5e7eb;
      --accent: #1d4ed8;
      --accent-dark: #1e3a8a;
      --radius: 16px;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark){
      :root {
        --bg: #0a0a0a;
        --fg: #f9fafb;
        --muted: #9ca3af;
        --card: #111;
        --stroke: #222;
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --shadow: 0 8px 20px rgba(0,0,0,.5);
      }
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; height: 100%;
      background: var(--bg); color: var(--fg);
      font-family: 'Lexend Deca', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .btn {
      padding: 12px 20px;
      font-weight: 700;
      border-radius: 12px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #fff;
      transition: background .2s ease, transform .1s ease;
      cursor: pointer;
    }
    .btn:hover { background: var(--accent-dark); }
    .btn:active { transform: scale(.98); }
    .btn.ghost {
      background: transparent;
      color: var(--accent);
    }
    .btn.ghost:hover { background: var(--accent); color:#fff; }
    .btn.full { width: 100%; }

    /* Login centrado */
    .center-screen {
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: 20px;
    }
    .auth-card {
      width: 100%;
      max-width: 460px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: left;
    }
    .hero {
      text-align: center;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .badge {
      display: inline-block;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      padding: 6px 12px;
      border: 1px solid var(--accent);
      border-radius: 999px;
      margin-bottom: 12px;
    }
    .title {
      font-size: clamp(24px, 5vw, 32px);
      font-weight: 800;
      margin: 0 0 6px;
    }
    .subtitle {
      font-size: 16px; color: var(--muted);
      margin: 0; line-height: 1.5;
    }
    .tabs {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 8px; padding: 8px; border: 1px solid var(--stroke);
      border-radius: 12px; margin-top: 8px;
    }
    .tab {
      text-align: center; padding: 10px 12px; border-radius: 10px;
      font-weight: 700; color: var(--muted); border: 1px solid transparent; cursor: pointer;
    }
    .tab.active { color: var(--fg); border-color: var(--stroke); background: rgba(0,0,0,.03); }
    .field { margin: 10px 0; }
    .label { font-size: 13px; font-weight: 700; margin-bottom: 6px; }
    input[type="email"], input[type="password"], input[type="text"]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--stroke);
      background:#fff0; color:var(--fg); outline:none;
    }
    input::placeholder { color: var(--muted); }
    .notice {
      border: 1px dashed var(--stroke);
      color: var(--muted);
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
    }

    /* Modal legal */
    .modal-backdrop{
      position: fixed; inset:0; background: rgba(0,0,0,0.45);
      display:flex; align-items:center; justify-content:center;
      padding: 20px;
    }
    .modal{
      width: 100%; max-width: 560px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: left;
    }
    .modal h2{ margin: 0 0 6px; font-size: 20px; }
    .modal p{ color: var(--muted); margin: 0; }
    .modal .actions{ display:flex; gap:10px; margin-top:16px; }

    /* Vista app fullscreen */
    .app-immersive {
      position: fixed;
      inset: 0;
      background: #000; /* mientras carga */
    }
    .app-immersive iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
    }
    /* Loader simple (opcional) */
    .loader {
      position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
      color: #fff; font-weight: 700; letter-spacing: .3px;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- Login centrado -->
  <div id="authView" class="center-screen">
    <div class="auth-card">
      <div class="hero">
        <div class="badge">Acceso a Carletes Games</div>
        <h1 class="title">Inicia sesión para continuar</h1>
        <p class="subtitle">Puedes crear cuenta con tu nombre o usar Google.</p>
      </div>

      <div id="authArea">
        <div class="tabs" role="tablist" aria-label="Modo de acceso">
          <div id="tab-login"  class="tab active" role="tab" tabindex="0">Iniciar sesión</div>
          <div id="tab-signup" class="tab"        role="tab" tabindex="0">Crear cuenta</div>
        </div>

        <!-- Login -->
        <div id="panel-login" style="margin-top:12px;">
          <div class="field">
            <div class="label">Correo</div>
            <input id="login-email" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="field">
            <div class="label">Contraseña</div>
            <input id="login-password" type="password" placeholder="••••••••" autocomplete="current-password" />
          </div>
          <button id="btn-login-email" class="btn full">Iniciar sesión</button>
        </div>

        <!-- Signup -->
        <div id="panel-signup" style="margin-top:12px; display:none;">
          <div class="field">
            <div class="label">Nombre</div>
            <input id="signup-name" type="text" placeholder="Tu nombre" autocomplete="name" />
          </div>
          <div class="field">
            <div class="label">Correo</div>
            <input id="signup-email" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="field">
            <div class="label">Contraseña (mín. 6)</div>
            <input id="signup-password" type="password" placeholder="••••••••" autocomplete="new-password" />
          </div>
          <button id="btn-signup-email" class="btn full">Crear cuenta</button>
        </div>

        <div style="height:12px"></div>
        <button id="btn-google" class="btn ghost full">Continuar con Google</button>

        <div style="height:12px"></div>
        <div id="status" class="notice">Esperando autenticación…</div>
      </div>
    </div>
  </div>

  <!-- Vista App a pantalla completa -->
  <div id="appView" class="app-immersive hidden">
    <div id="loader" class="loader">Cargando contenido…</div>
    <iframe id="appIframe" allow="clipboard-read; clipboard-write; fullscreen *;"></iframe>
  </div>

  <!-- Modal legal -->
  <div id="legalModal" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="legal-title">
      <h2 id="legal-title">Aviso importante</h2>
      <p>
        Accedes bajo tu propia responsabilidad y <strong>deslindas a “carletes”</strong> de cualquier uso indebido de esta página o de sus contenidos.
        Si no estás de acuerdo, presiona “Cancelar”.
      </p>
      <div class="actions">
        <button id="btn-accept" class="btn">Acepto</button>
        <button id="btn-cancel" class="btn ghost">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, updateProfile,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyAdIYosKvktrWeuoyrupSVRLE3ekfv74IU",
      authDomain: "carletes-games.firebaseapp.com",
      projectId: "carletes-games",
      storageBucket: "carletes-games.firebasestorage.app",
      messagingSenderId: "6199017607",
      appId: "1:6199017607:web:f1a2409202bdf08e3bf822",
      measurementId: "G-DS1SXZ8QN2"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(_) {}

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Elements
    const authView   = document.getElementById('authView');
    const appView    = document.getElementById('appView');
    const appIframe  = document.getElementById('appIframe');
    const loaderEl   = document.getElementById('loader');

    const tabLogin   = document.getElementById('tab-login');
    const tabSignup  = document.getElementById('tab-signup');
    const panelLogin = document.getElementById('panel-login');
    const panelSignup= document.getElementById('panel-signup');

    const loginEmail = document.getElementById('login-email');
    const loginPass  = document.getElementById('login-password');
    const signupName = document.getElementById('signup-name');
    const signupEmail= document.getElementById('signup-email');
    const signupPass = document.getElementById('signup-password');

    const btnLoginEmail  = document.getElementById('btn-login-email');
    const btnSignupEmail = document.getElementById('btn-signup-email');
    const btnGoogle      = document.getElementById('btn-google');

    const statusBox  = document.getElementById('status');
    const legalModal = document.getElementById('legalModal');
    const btnAccept  = document.getElementById('btn-accept');
    const btnCancel  = document.getElementById('btn-cancel');

    // URL FINAL FIJA (siempre esta)
    const FINAL_URL_BASE = 'https://institutodebiologiamexicana.com/';

    // Modal legal
    btnAccept.addEventListener('click', () => {
      legalModal.style.display = 'none';
    });
    btnCancel.addEventListener('click', () => {
      try { window.top.close(); } catch { history.back(); }
    });

    // Tabs
    function setTab(which){
      const isLogin = which === 'login';
      tabLogin.classList.toggle('active', isLogin);
      tabSignup.classList.toggle('active', !isLogin);
      panelLogin.style.display  = isLogin ? 'block' : 'none';
      panelSignup.style.display = isLogin ? 'none'  : 'block';
    }
    tabLogin.addEventListener('click', () => setTab('login'));
    tabSignup.addEventListener('click', () => setTab('signup'));

    // Helpers
    function status(msg){ statusBox.textContent = msg; }
    function disableAuth(disabled){
      [btnLoginEmail, btnSignupEmail, btnGoogle].forEach(b => b.disabled = disabled);
    }
    function buildFinalUrl(user){
      // Si NO quieres pasar el nombre/email, devuelve simplemente FINAL_URL_BASE.
      const who = (user?.displayName || user?.email || 'usuario');
      const url = new URL(FINAL_URL_BASE);
      url.searchParams.set('user', who); // ← elimina esta línea si no quieres enviar ?user=
      return url.toString();
    }
    function showFullApp(url){
      authView.classList.add('hidden');
      appView.classList.remove('hidden');
      loaderEl.classList.remove('hidden');
      appIframe.addEventListener('load', () => loaderEl.classList.add('hidden'), { once: true });
      appIframe.src = url;
    }

    // Email/Password
    btnLoginEmail.addEventListener('click', async () => {
      const email = loginEmail.value.trim();
      const pass  = loginPass.value.trim();
      if(!email || !pass) return status('Correo y contraseña son requeridos.');
      try {
        disableAuth(true);
        await signInWithEmailAndPassword(auth, email, pass);
        status('Inicio de sesión correcto.');
      } catch (e) {
        status(mapAuthError(e));
      } finally { disableAuth(false); }
    });

    // Signup con nombre
    btnSignupEmail.addEventListener('click', async () => {
      const name  = signupName.value.trim();
      const email = signupEmail.value.trim();
      const pass  = signupPass.value.trim();
      if(!name)  return status('Por favor, escribe tu nombre.');
      if(!email) return status('El correo es requerido.');
      if(pass.length < 6) return status('Contraseña mínima de 6 caracteres.');
      try {
        disableAuth(true);
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });
        status('Cuenta creada e iniciada correctamente.');
      } catch (e) {
        status(mapAuthError(e));
      } finally { disableAuth(false); }
    });

    // Google
    btnGoogle.addEventListener('click', async () => {
      try {
        disableAuth(true);
        await signInWithPopup(auth, provider);
        status('Autenticado con Google.');
      } catch (e) {
        status(mapAuthError(e));
      } finally { disableAuth(false); }
    });

    // Estado de sesión → cargar fullpage SIEMPRE al dominio fijo
    onAuthStateChanged(auth, (user) => {
      if (user) {
        status(`Autenticado como ${user.displayName || user.email}. Cargando contenido…`);
        const finalUrl = buildFinalUrl(user);
        showFullApp(finalUrl);
      }
    });

    // Errores comunes
    function mapAuthError(e){
      const code = (e && e.code) ? e.code : '';
      switch(code){
        case 'auth/invalid-credential': return 'Credenciales inválidas.';
        case 'auth/invalid-email': return 'Correo inválido.';
        case 'auth/user-disabled': return 'Usuario deshabilitado.';
        case 'auth/user-not-found': return 'Usuario no encontrado.';
        case 'auth/wrong-password': return 'Contraseña incorrecta.';
        case 'auth/email-already-in-use': return 'Ese correo ya está en uso.';
        case 'auth/weak-password': return 'Contraseña débil (mín. 6).';
        case 'auth/popup-blocked': return 'El navegador bloqueó la ventana emergente.';
        case 'auth/popup-closed-by-user': return 'Cerraste la ventana de Google.';
        default: return 'Error de autenticación. Intenta nuevamente.';
      }
    }

    // Estado inicial
    setTab('login');
  </script>
</body>
</html>
